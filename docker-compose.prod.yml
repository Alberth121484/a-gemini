# A-Gemini Agent - Production Docker Compose
# Usa imagen desde GitHub Container Registry
# Solo requiere configurar .env y ejecutar: docker-compose -f docker-compose.prod.yml up -d

services:
  a-gemini-agent:
    image: ghcr.io/alberth121484/a-gemini:latest
    container_name: a-gemini-agent
    restart: unless-stopped
    stop_grace_period: 30s
    
    expose:
      - "8000"
    
    ports:
      - "1407:8000"
    
    networks:
      - tiendasneto
    
    environment:
      # Slack Configuration
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN}
      - SLACK_APP_TOKEN=${SLACK_APP_TOKEN}
      - SLACK_SIGNING_SECRET=${SLACK_SIGNING_SECRET}
      
      # Google/Gemini Configuration
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      
      # OpenAI Configuration (for audio)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      
      # Anthropic Configuration (optional)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      
      # Tavily Configuration (web search)
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      
      # ConvertAPI Configuration (document conversion)
      - CONVERT_API_KEY=${CONVERT_API_KEY}
      
      # Database Configuration
      - DATABASE_URL=${DATABASE_URL}
      - DATABASE_POOL_MIN=${DATABASE_POOL_MIN:-10}
      - DATABASE_POOL_MAX=${DATABASE_POOL_MAX:-100}
      
      # Redis Configuration
      - REDIS_URL=${REDIS_URL:-redis://a-gemini-redis:6379/0}
      
      # Application Configuration
      - HOST=0.0.0.0
      - PORT=8000
      - WORKERS=${WORKERS:-4}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      
      # Rate Limiting
      - RATE_LIMIT_REQUESTS=${RATE_LIMIT_REQUESTS:-100}
      - RATE_LIMIT_WINDOW=${RATE_LIMIT_WINDOW:-60}
      
      # Model Configuration
      - DEFAULT_MODEL=${DEFAULT_MODEL:-gemini-2.5-pro}
      - IMAGE_MODEL=${IMAGE_MODEL:-imagen-4.0-ultra-generate-preview-06-06}
      
      # Memory Configuration
      - CHAT_HISTORY_TABLE=${CHAT_HISTORY_TABLE:-n8n_chat_histories_geminiv2}
      - LOGS_TABLE=${LOGS_TABLE:-logsgemini}
      - CONTEXT_WINDOW_LENGTH=${CONTEXT_WINDOW_LENGTH:-3}
      
      # System
      - TZ=America/Mexico_City
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.5"
          memory: 512M
    
    labels:
      - traefik.enable=true
      - traefik.http.routers.a-gemini.rule=Host(`a-gemini.tiendasnetows.com`)
      - traefik.http.routers.a-gemini.entrypoints=websecure
      - traefik.http.routers.a-gemini.priority=1
      - traefik.http.routers.a-gemini.tls.certresolver=letsencryptresolver
      - traefik.http.routers.a-gemini.service=a-gemini
      - traefik.http.services.a-gemini.loadbalancer.server.port=8000
      - traefik.http.services.a-gemini.loadbalancer.passHostHeader=1
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    volumes:
      - a-gemini-logs:/app/logs
    
    depends_on:
      - a-gemini-redis

  a-gemini-redis:
    image: redis:7-alpine
    container_name: a-gemini-redis
    restart: unless-stopped
    command: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru
    networks:
      - tiendasneto
    volumes:
      - a-gemini-redis-data:/data
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "0.25"
          memory: 256M

networks:
  tiendasneto:
    external: true
    name: tiendasneto

volumes:
  a-gemini-logs:
    driver: local
  a-gemini-redis-data:
    driver: local
